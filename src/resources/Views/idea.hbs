<div class="container">
    <h1 class="text-center">Idea Layout</h1>


<div class="mt-4">
    <ul class="row">
        <div class="col-3 list-idea">
                <table id="customers">
                    <tr>
                        <th>Most Interactive Idea</th>
                    </tr>
                {{#each idea}}
                {{!-- <li><a href="/idea/{{this.slug}}">{{this.title}}</a></li> --}}
                    
                    <tr>
                        <td><a href="/idea/{{this.slug}}">{{this.title}}</a></td>
                    </tr>
                {{/each}}
                </table>
        </div>

        <div style="display: block;" class="col-9 row content-idea">
            {{#each idea}}
            <div class="col-12 mt-4">
                <div class="card">
                    <div class="card-body">
                        <a href="/idea/{{this.slug}}">
                            <h5 class="card-title">{{this.title}}</h5>
                        </a>
                        <p class="card-text idea-detail">{{this.detail}}</p>
                        Author: <p class="card-text">{{this.author}}</p>
                        Category: <p class="card-text">{{this.type}}</p>
                        File: <p class="card-text"><a href="../../idea/{{this.file}}">{{this.file}}</a></p>
                        <a href="/idea/{{this.slug}}" class="btn btn-primary"> Detail </a>
                        <br>
                        <button onclick="actOnPost(event);" class="btn btn-success"
                                data-post-id="{{ this._id }}">Like
                        </button>
                        <button onclick="actOnPost(event);" class="btn btn-success"
                                data-post-id="{{ this._id }}">Unlike
                        </button>
                        <p><span id="ratings-{{ this._id }}">{{ this.ratings }}</span> liked this</p>

                        <form action="/idea/{{this._id}}/storeComment?_method=PUT" method="post"> 
                            <label for="idea-comment">Write a comment:</label>
                            <input class="form-control" type="text" style="" id="comment-user-name" name="userName">
                            <text>content:</text><input class="form-control" type="text" name="content">
                            <text>Cmt at:</text><input class="form-control" style="" id="comment-date" name="commentAt">

                            <text>Idea id:</text><input type="" id="comment-idea-id" name="idea_id" value="{{this._id}}">

                            <p>
                                <input type="checkbox" style="" id="comment-annoymous" value="true" name="annoymous">
                                Comment as anonymous
                            </p>
                            <input type="submit" value="Submit">
                        </form> 
                        

                        <div class="card">
                            <p>Comments: </p>
                        {{#comment}}
                            {{#if annoymous}}
                            <input id="comment-posted-username" value="Annoymous" class="mt-4" disabled>
                            {{else}}
                            <input id="comment-posted-username" value="Name: {{userName}}" class="mt-4" disabled>
                            {{/if}}
                            <p>Content: {{content}}</p>
                            <p>Comment at (Hour): {{moment commentAt format="HH:mm"}}</p>
                            <p>Comment at (Date): {{moment commentAt format="DD-MM-YYYY"}}</p>
                        {{/comment}}
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </ul>
    <div class="pagination-idea-page">
        <li class="page-item previous-page disable"><a class="idea-page-link" href="#">Prev</a></li>
        <li class="page-item current-page active"><a class="idea-page-link" href="#">1</a></li>
        <li class="page-item dots"><a class="idea-page-link" href="#">...</a></li>
        <li class="page-item current-page"><a class="idea-page-link" href="#">5</a></li>
        <li class="page-item current-page"><a class="idea-page-link" href="#">6</a></li>
        <li class="page-item dots"><a class="idea-page-link" href="#">...</a></li>
        <li class="page-item current-page"><a class="idea-page-link" href="#">10</a></li>
        <li class="page-item next-page"><a class="idea-page-link" href="#">Next</a></li>
    </div>
</div>


    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script>
        /* function doComment(form){
            $.ajax({
                url: "/idea/do-comment",
                method: "POST",
                data: {
                    userName: form.commentUserName.value, 
                    content: form.commentContent.value, 
                    commentAt: form.commentAt.value, 
                    annoymous: form.commentAnnoymous.value, 
                    idea_id: form.idea_id.value,
                }, 
                    success: function (res){
                        alert(res);
                    }
            });
            return false
        } 
        $(document).ready(function doComment(form) {
            $.ajax({
                url: "/idea/do-comment",
                method: "POST",
                data: {
                    userName: form.commentUserName.value, 
                    content: form.commentContent.value, 
                    commentAt: form.commentAt.value, 
                    annoymous: form.commentAnnoymous.value, 
                    idea_id: form.idea_id.value,
                }, 
                    success: function (res){
                        alert(res);
                    }
            });
            return false
        });*/
        
        $(document).ready(function () {
            //Assign the user name of who is using to input form
            $('input[id="comment-user-name"]').val("{{userLogin.username}}");
            //Assign time now for posting cmt
            $('input[id="comment-date"]').val(Date.now());
        });

    </script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        var updateIdeaRatings = {
            Like: function (postId) {
                document.querySelector('#ratings-' + postId).textContent++;
            },
            Unlike: function(postId) {
                document.querySelector('#ratings-' + postId).textContent--;
            }
        };
    
        var toggleButtonText = {
            Like: function(button) {
                button.textContent = "Unlike";
            },
            Unlike: function(button) {
                button.textContent = "Like";
            }
        };
    
        var actOnPost = function (event) {
            var postId = event.target.dataset.postId;
            var action = event.target.textContent.trim();
            toggleButtonText[action](event.target);
            updateIdeaRatings[action](postId);
            axios.post('/idea/' + postId + '/interactive?_method=PUT', { action: action });
        };
    </script>

    <script>
        function getPageList(totalPages, page, maxLength) {
            function range(start, end) {
                return Array.from(Array(end - start + 1), (_, i) => i + start);
            }

            var sideWidth = maxLength < 9 ? 1 : 2;
            var leftWidth = (maxLength - sideWidth * 2 - 3) >> 1;
            var rightWidth = (maxLength - sideWidth * 2 - 3) >> 1;

            if(totalPages <= maxLength) {
                return range(1, totalPages);
            }

            if(page <= maxLength - sideWidth - 1 - rightWidth) {
                return range(1, maxLength - sideWidth - 1).concat(0, range(totalPages - sideWidth + 1, totalPages));
            }

            if(page >= maxLength - sideWidth - 1 - rightWidth) {
                return range(1,sideWidth).concat(0, range(totalPages - sideWidth - 1 - rightWidth - leftWidth, totalPages));
            }

            return range(1, sideWidth).concat(0, range(page - leftWidth, page + rightWidth), 0, range(totalPages - sideWidth + 1, totalPages));
        }

        $(function(){
            var numberOfItems = $(".content-idea .card").length;
            var limitPerPage = 10;
            var totalPages = Math.ceil(numberOfItems / limitPerPage);
            var paginationSize = 7;
            var currentPage;

            function showPage(whichPage) {
                if(whichPage < 1 || whichPage > totalPages) return false;

                currentPage = whichPage;

                $(".content-idea .card").hide().slice((currentPage - 1) * limitPerPage, currentPage * limitPerPage).show();

                $(".pagination-idea-page li").slice(1, -1).remove();

                getPageList(totalPages, currentPage, paginationSize).forEach(item => {
                    $("<li>").addClass("page-item").addClass(item ? "current-page" : "dots")
                    .toggleClass("active", item === currentPage).append($("<a>").addClass("idea-page-link")
                    .attr({href: "javascript:void(0)"}).text(item || "...")).insertBefore(".next-page");
                });

                $(".previous-page").toggleClass("disable", currentPage === 1);
                $(".next-page").toggleClass("disable", currentPage === totalPages);
                return true;
            }

            $(".pagination-idea-page").append(
                $("<li>").addClass("page-item").addClass("previous-page").append($("<a>").addClass("idea-page-link").attr({href: "javascript:void(0)"}).text("Prev")),
                $("<li>").addClass("page-item").addClass("next-page").append($("<a>").addClass("idea-page-link").attr({href: "javascript:void(0)"}).text("Next")),
                
            );

            $(".card-content-idea").show();
            showPage(1);

            $(document).on("click", ".pagination-idea-page li.current-page:not(.active)", function(){
                return showPage(+$(this).text());
            });

            $(".next-page").on("click", function(){
                return showPage(currentPage + 1);
            });

            $(".previous-page").on("click", function(){
                return showPage(currentPage - 1);
            });

        });
    </script>

</div>